name: Basic pull request checks

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize

# Use concurrency to ensure that only a single job or workflow using the same concurrency group will run at a time
concurrency:
  group: '${{ github.workflow }} @ ${{ github.event.pull_request.head.label || github.head_ref || github.ref }}'
  cancel-in-progress: true  # Cancel previously queued jobs and run the latest
        
jobs:
  pr-title-check:
    runs-on: self-hosted
    timeout-minutes: 5
    outputs:
      run_id: ${{ steps.run_id.outputs.run_id }}
    steps:
      - uses: SatelCreative/pr-title-gitmoji-check@1.0.2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          pass_on_octokit_error: false

      # To  make sure next job only runs one 1st commit
      - name: Get run id
        id: run_id
        if: ${{ github.event_name == 'pull_request' &&  github.event.action == 'opened'}}
        run: echo "run_id=1" >> $GITHUB_OUTPUT    

  broken-link-check:
    needs: pr-title-check
    timeout-minutes: 5
    if: ${{ needs.pr-title-check.outputs.run_id == 1 }}
    runs-on: ubuntu-latest #switch to self hosted after the network issue at the office is fixed
    steps:
      - name: Check out repository
        uses: actions/checkout@v4.2.2
  
      - name: Link Checker
        id: lychee
        uses: lycheeverse/lychee-action@v2.4.1
        with:
          fail: true
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}} 
